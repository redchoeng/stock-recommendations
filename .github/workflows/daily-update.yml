name: Daily Stock Report Update

on:
  schedule:
    # 18:00 KST ~ 06:00 KST (09:00 ~ 21:00 UTC) ë§¤ì‹œ ì •ê° ì‹¤í–‰
    - cron: '0 9-21 * * *'

  push:
    branches:
      - main

  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install yfinance pandas numpy

      - name: Generate NASDAQ 100 Report
        run: |
          python generate_daily_report_v2.py

      - name: Generate Value Stocks Report
        run: |
          cat > generate_value_temp.py << 'SCRIPT'
          import yfinance as yf
          from datetime import datetime
          import warnings
          warnings.filterwarnings('ignore')

          VALUE_TICKERS = [
              'JPM', 'BAC', 'WFC', 'GS', 'MS', 'C', 'BRK-B', 'V', 'MA', 'AXP',
              'JNJ', 'UNH', 'PFE', 'ABBV', 'MRK', 'LLY', 'TMO', 'ABT', 'BMY', 'CVS',
              'PG', 'KO', 'PEP', 'WMT', 'COST', 'TGT', 'CL', 'GIS', 'K', 'MO',
              'XOM', 'CVX', 'COP', 'SLB', 'EOG', 'MPC', 'VLO', 'PSX', 'OXY', 'HAL',
              'LMT', 'RTX', 'BA', 'CAT', 'DE', 'UNP', 'UPS', 'FDX', 'HON', 'GE',
              'NEE', 'DUK', 'SO', 'D', 'AEP', 'EXC', 'SRE', 'XEL', 'WEC', 'ED'
          ]

          def analyze_stock(ticker):
              try:
                  stock = yf.Ticker(ticker)
                  hist = stock.history(period='6mo')
                  if hist.empty or len(hist) < 20:
                      return None

                  info = stock.info
                  current_price = hist['Close'].iloc[-1]
                  sma20 = hist['Close'].rolling(20).mean().iloc[-1]

                  score = 50
                  div_yield = info.get('dividendYield', 0) or 0
                  # yfinanceê°€ ì†Œìˆ˜(0.03) ë˜ëŠ” í¼ì„¼íŠ¸(3.0)ë¡œ ë°˜í™˜í•˜ëŠ” ê²½ìš° ì²˜ë¦¬
                  if div_yield > 1:
                      div_yield_pct = div_yield
                      div_yield_decimal = div_yield / 100
                  else:
                      div_yield_pct = div_yield * 100
                      div_yield_decimal = div_yield

                  if div_yield_decimal > 0.02: score += 15
                  if div_yield_decimal > 0.04: score += 10
                  if info.get('trailingPE', 100) and info['trailingPE'] < 20: score += 10
                  if info.get('profitMargins', 0) and info['profitMargins'] > 0.1: score += 10
                  if current_price > sma20: score += 5

                  return {
                      'ticker': ticker,
                      'name': info.get('shortName', ticker),
                      'price': current_price,
                      'score': min(score, 100),
                      'dividend': div_yield_pct,
                      'sector': info.get('sector', 'N/A')
                  }
              except:
                  return None

          stocks = []
          for t in VALUE_TICKERS:
              result = analyze_stock(t)
              if result:
                  stocks.append(result)
                  print(f"  {t}: {result['score']}ì ")

          stocks.sort(key=lambda x: x['score'], reverse=True)
          recommended = [s for s in stocks if s['score'] >= 45]

          now = datetime.now()
          html = f'''<!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Value Stocks - {now.strftime("%Y-%m-%d")}</title>
              <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(180deg, #87CEEB 0%, #98D8C8 30%, #F7DC6F 70%, #FADBD8 100%); background-attachment: fixed; padding: 20px; min-height: 100vh; }}
                  .container {{ max-width: 1200px; margin: 0 auto; }}
                  .header {{ background: white; border-radius: 30px; padding: 35px; margin-bottom: 25px; box-shadow: 0 8px 0 #E8A838; border: 4px solid #5D4E37; text-align: center; }}
                  .header h1 {{ color: #5D4E37; font-size: 2em; }}
                  .header .date {{ color: #E8A838; margin-top: 10px; }}
                  .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }}
                  .summary-card {{ background: linear-gradient(180deg, #FFF8DC, #FAEBD7); border-radius: 20px; padding: 20px; border: 3px solid #5D4E37; text-align: center; }}
                  .summary-card .value {{ color: #FF6B35; font-size: 1.8em; font-weight: bold; }}
                  .stock-card {{ background: white; border-radius: 20px; padding: 25px; margin-bottom: 15px; border: 3px solid #5D4E37; box-shadow: 0 5px 0 #E8A838; }}
                  .stock-card h2 {{ color: #5D4E37; margin-bottom: 10px; }}
                  .stock-card .ticker {{ color: #E8A838; }}
                  .stock-card .score {{ background: #E8A838; color: white; padding: 8px 20px; border-radius: 20px; float: right; }}
                  .stock-card .score.high {{ background: #4CAF50; }}
                  .dividend {{ color: #4CAF50; font-weight: bold; }}
                  .back-link {{ display: block; text-align: center; margin-bottom: 20px; color: #5D4E37; }}
                  .footer {{ background: rgba(255,255,255,0.9); border-radius: 20px; padding: 20px; text-align: center; color: #7B6B4F; margin-top: 30px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <a href="index.html" class="back-link">â† ë©”ì¸ìœ¼ë¡œ</a>
                  <div class="header">
                      <div style="font-size: 3em;">ğŸ’°</div>
                      <h1>Value Stocks Recommendations</h1>
                      <div class="date">{now.strftime("%Y-%m-%d %H:%M")} UTC ì—…ë°ì´íŠ¸</div>
                  </div>
                  <div class="summary">
                      <div class="summary-card"><div class="label">ë¶„ì„ ì¢…ëª©</div><div class="value">{len(stocks)}ê°œ</div></div>
                      <div class="summary-card"><div class="label">ì¶”ì²œ ì¢…ëª©</div><div class="value">{len(recommended)}ê°œ</div></div>
                  </div>
          '''
          for s in recommended[:20]:
              score_class = 'high' if s['score'] >= 70 else ''
              div_text = f" | <span class='dividend'>ë°°ë‹¹ {s['dividend']:.1f}%</span>" if s['dividend'] > 0 else ""
              html += f'''
                  <div class="stock-card">
                      <span class="score {score_class}">{s['score']}ì </span>
                      <h2>{s['name']}</h2>
                      <span class="ticker">{s['ticker']}</span> | ${s['price']:.2f}{div_text}
                  </div>'''

          html += '''
                  <div class="footer">âš ï¸ ë³¸ ë¦¬í¬íŠ¸ëŠ” íˆ¬ì ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.</div>
              </div>
          </body>
          </html>'''

          with open('value_report.html', 'w', encoding='utf-8') as f:
              f.write(html)
          print(f"\\nValue ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: {len(recommended)}ê°œ ì¶”ì²œ")
          SCRIPT
          python generate_value_temp.py

      - name: Update index.html links
        run: |
          # NASDAQ ë¦¬í¬íŠ¸ íŒŒì¼ëª… ì°¾ê¸°
          NASDAQ_REPORT=$(ls -t nasdaq100_report_*.html 2>/dev/null | head -1 || echo "")

          # index.htmlì˜ ë§í¬ ì—…ë°ì´íŠ¸ (íŒŒì¼ì´ ìˆìœ¼ë©´)
          if [ -n "$NASDAQ_REPORT" ] && [ -f "index.html" ]; then
            # NASDAQ ë§í¬ ì—…ë°ì´íŠ¸
            sed -i "s|href=\"nasdaq100_report[^\"]*\.html\"|href=\"$NASDAQ_REPORT\"|g" index.html
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto update reports - $(date -u '+%Y-%m-%d %H:%M') UTC"
            git push
          fi
